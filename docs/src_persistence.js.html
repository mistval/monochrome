<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/persistence.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Blacklist.html">Blacklist</a><ul class='methods'><li data-type='method'><a href="Blacklist.html#blacklistUser">blacklistUser</a></li><li data-type='method'><a href="Blacklist.html#isUserBlacklisted">isUserBlacklisted</a></li><li data-type='method'><a href="Blacklist.html#isUserBlacklistedQuick">isUserBlacklistedQuick</a></li><li data-type='method'><a href="Blacklist.html#unblacklistUser">unblacklistUser</a></li></ul></li><li><a href="Command.html">Command</a></li><li><a href="CommandManager.html">CommandManager</a><ul class='methods'><li data-type='method'><a href="CommandManager.html#getHelpCommandHelper">getHelpCommandHelper</a></li></ul></li><li><a href="FPersistStoragePlugin.html">FPersistStoragePlugin</a><ul class='methods'><li data-type='method'><a href="FPersistStoragePlugin.html#clear">clear</a></li><li data-type='method'><a href="FPersistStoragePlugin.html#close">close</a></li><li data-type='method'><a href="FPersistStoragePlugin.html#deleteKey">deleteKey</a></li><li data-type='method'><a href="FPersistStoragePlugin.html#editValue">editValue</a></li><li data-type='method'><a href="FPersistStoragePlugin.html#getValue">getValue</a></li></ul></li><li><a href="HelpCommandHelper.html">HelpCommandHelper</a><ul class='methods'><li data-type='method'><a href="HelpCommandHelper.html#findCommand">findCommand</a></li><li data-type='method'><a href="HelpCommandHelper.html#getEnabledNonHiddenCommands">getEnabledNonHiddenCommands</a></li><li data-type='method'><a href="HelpCommandHelper.html#getNonHiddenCommands">getNonHiddenCommands</a></li></ul></li><li><a href="MessageProcessor.html">MessageProcessor</a></li><li><a href="MongoDBStoragePlugin.html">MongoDBStoragePlugin</a><ul class='methods'><li data-type='method'><a href="MongoDBStoragePlugin.html#clear">clear</a></li><li data-type='method'><a href="MongoDBStoragePlugin.html#close">close</a></li><li data-type='method'><a href="MongoDBStoragePlugin.html#deleteKey">deleteKey</a></li><li data-type='method'><a href="MongoDBStoragePlugin.html#editValue">editValue</a></li><li data-type='method'><a href="MongoDBStoragePlugin.html#getValue">getValue</a></li></ul></li><li><a href="Monochrome.html">Monochrome</a><ul class='methods'><li data-type='method'><a href="Monochrome.html#connect">connect</a></li><li data-type='method'><a href="Monochrome.html#getBlacklist">getBlacklist</a></li><li data-type='method'><a href="Monochrome.html#getCommandManager">getCommandManager</a></li><li data-type='method'><a href="Monochrome.html#getErisBot">getErisBot</a></li><li data-type='method'><a href="Monochrome.html#getLogger">getLogger</a></li><li data-type='method'><a href="Monochrome.html#getNavigationManager">getNavigationManager</a></li><li data-type='method'><a href="Monochrome.html#getPersistence">getPersistence</a></li><li data-type='method'><a href="Monochrome.html#getSettings">getSettings</a></li><li data-type='method'><a href="Monochrome.html#reload">reload</a></li><li data-type='method'><a href="Monochrome.html#stop">stop</a></li><li data-type='method'><a href="Monochrome.html#userIsServerAdmin">userIsServerAdmin</a></li><li data-type='method'><a href="Monochrome.html#waitForMessage">waitForMessage</a></li></ul></li><li><a href="Navigation.html">Navigation</a><ul class='methods'><li data-type='method'><a href="Navigation.html#.fromOneDimensionalContents">fromOneDimensionalContents</a></li><li data-type='method'><a href="Navigation.html#.fromOneNavigationChapter">fromOneNavigationChapter</a></li></ul></li><li><a href="NavigationChapter.html">NavigationChapter</a><ul class='methods'><li data-type='method'><a href="NavigationChapter.html#.fromContent">fromContent</a></li></ul></li><li><a href="NavigationManager.html">NavigationManager</a><ul class='methods'><li data-type='method'><a href="NavigationManager.html#show">show</a></li></ul></li><li><a href="Persistence.html">Persistence</a><ul class='methods'><li data-type='method'><a href="Persistence.html#deleteData">deleteData</a></li><li data-type='method'><a href="Persistence.html#editData">editData</a></li><li data-type='method'><a href="Persistence.html#editDataForServer">editDataForServer</a></li><li data-type='method'><a href="Persistence.html#editDataForUser">editDataForUser</a></li><li data-type='method'><a href="Persistence.html#editGlobalData">editGlobalData</a></li><li data-type='method'><a href="Persistence.html#editPrefixesForServerId">editPrefixesForServerId</a></li><li data-type='method'><a href="Persistence.html#getData">getData</a></li><li data-type='method'><a href="Persistence.html#getDataForServer">getDataForServer</a></li><li data-type='method'><a href="Persistence.html#getDataForUser">getDataForUser</a></li><li data-type='method'><a href="Persistence.html#getGlobalData">getGlobalData</a></li><li data-type='method'><a href="Persistence.html#getPrefixesForMessage">getPrefixesForMessage</a></li><li data-type='method'><a href="Persistence.html#getPrefixesForServer">getPrefixesForServer</a></li><li data-type='method'><a href="Persistence.html#getPrimaryPrefixForMessage">getPrimaryPrefixForMessage</a></li><li data-type='method'><a href="Persistence.html#resetPrefixesForServerId">resetPrefixesForServerId</a></li><li data-type='method'><a href="Persistence.html#stop">stop</a></li></ul></li><li><a href="Settings.html">Settings</a><ul class='methods'><li data-type='method'><a href="Settings.html#getInternalSettingValue">getInternalSettingValue</a></li><li data-type='method'><a href="Settings.html#getRawSettingsTree">getRawSettingsTree</a></li><li data-type='method'><a href="Settings.html#getTreeNodeForUniqueId">getTreeNodeForUniqueId</a></li><li data-type='method'><a href="Settings.html#getUserFacingSettingValue">getUserFacingSettingValue</a></li><li data-type='method'><a href="Settings.html#resetServerAndChannelSettings">resetServerAndChannelSettings</a></li><li data-type='method'><a href="Settings.html#resetUserSettings">resetUserSettings</a></li><li data-type='method'><a href="Settings.html#setChannelSettingValue">setChannelSettingValue</a></li><li data-type='method'><a href="Settings.html#setServerWideSettingValue">setServerWideSettingValue</a></li><li data-type='method'><a href="Settings.html#setUserSettingValue">setUserSettingValue</a></li><li data-type='method'><a href="Settings.html#userFacingValueIsValidForSetting">userFacingValueIsValidForSetting</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-_bunyan.Logger_.html">bunyan.Logger</a></li><li><a href="external-_Eris.Client_.html">Eris.Client</a></li><li><a href="external-_Eris.Message_.html">Eris.Message</a></li><li><a href="external-_Eris.TextChannel_.html">Eris.TextChannel</a></li></ul><h3>Interfaces</h3><ul><li><a href="StoragePlugin.html">StoragePlugin</a><ul class='methods'><li data-type='method'><a href="StoragePlugin.html#clear">clear</a></li><li data-type='method'><a href="StoragePlugin.html#close">close</a></li><li data-type='method'><a href="StoragePlugin.html#deleteKey">deleteKey</a></li><li data-type='method'><a href="StoragePlugin.html#editValue">editValue</a></li><li data-type='method'><a href="StoragePlugin.html#getValue">getValue</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/persistence.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const USER_DATA_KEY_PREFIX = 'User';
const SERVER_DATA_KEY_PREFIX = 'Server';
const GLOBAL_DATA_KEY = 'Global';

function keyForUserId(userId) {
  return USER_DATA_KEY_PREFIX + userId;
}

function keyForServerId(serverId) {
  return SERVER_DATA_KEY_PREFIX + serverId;
}

/**
 * @callback Persistence~editFunction
 * @param {Object} data - The current data associated with the key. If there is none, an empty object {} is given. This data can be manipulated and then returned to persist it.
 * @returns {Object} The new data to associate with the key.
 */

/**
 * Read or write persistent data that is persisted even if the process is killed.
 * The persistence is a key-value store backed by [fpersist]{@link https://www.npmjs.com/package/fpersist}.
 * You can store values for any key, but there are convenience methods provided for storing data
 * attached to a particular user or server, or in a global store.
 * Persistence can be accessed via {@link Monochrome#getPersistence}.
 * For examples of using persistence to store and retrieve persistent data, see the
 * [demo addQuote command]{@link https://github.com/mistval/monochrome-demo/blob/master/commands/addquote.js}
 * and [demo getRandomQuote command]{@link https://github.com/mistval/monochrome-demo/blob/master/commands/getrandomquote.js}.
 * @hideconstructor
 */
class Persistence {
  constructor(defaultPrefixes, logger, storagePlugin) {
    this.storage = storagePlugin;
    this.defaultPrefixes_ = defaultPrefixes;
    this.prefixesForServerId_ = {};
    this.logger = logger.child({
      component: 'Monochrome::Persistence',
    });

    this.getGlobalData().then(data => {
      this.prefixesForServerId_ = data.prefixes || {};
    }).catch(err => {
      this.logger.error({
        event: 'ERROR LOADING PREFIXES',
        err,
      });
    });
  }

  /**
   * Delete the value associated with a specified key.
   * If the key doesn't exist, nothing happens and no error is thrown.
   * @param {string} key
   * @async 
   */
  deleteData(key) {
    return this.storage.deleteKey(key);
  }

  /**
   * Get the value associated with the specified key. If no such value exists,
   * an empty object {} is returned.
   * @param {string} key
   * @returns {Object} The value associated with the specified key.
   * @async
   * @example
const data = await persistence.getData('some_key');
console.log(JSON.stringify(data));
   */
  getData(key) {
    return this.storage.getValue(key, {});
  }

  /**
   * Get the data associated with a user. If no such data exists, an empty
   * object {} is returned.
   * @param {string} userId
   * @returns {Object} The value associated with the specified userId
   * @async
   * @example
const userId = '123456789';
const data = await persistence.getDataForUser(userId);
console.log(JSON.stringify(data));
   */
  getDataForUser(userId) {
    return this.getData(keyForUserId(userId));
  }

  /**
   * Get the data associated with a server. If no such data exists, an empty
   * object {} is returned.
   * @param {string} serverId
   * @returns {Object} The value associated with the specified serverId
   * @async
   * @example
const serverId = '123456789';
const data = await persistence.getDataForServer(serverId);
console.log(JSON.stringify(data));
   */
  getDataForServer(serverId) {
    return this.getData(keyForServerId(serverId));
  }

  /**
   * Get the global data. If no such data exists, an empty
   * object {} is returned.
   * @returns {Object} The global data.
   * @async
   * @example
const data = await persistence.getGlobalData();
console.log(JSON.stringify(data));
   */
  getGlobalData() {
    return this.getData(GLOBAL_DATA_KEY);
  }

  /**
   * Get the command prefixes associated with a server ID. This method is synchronous, in order to avoid the overhead
   * of using promises. If called very soon after the bot starts, it might not return the correct prefixes. It
   * might return the default prefixes even though the server has custom prefixes.
   * @param {string} serverId
   * @returns {string[]}
   * @example
const serverId = '123456789';
const prefixes = persistence.getPrefixesForServer(serverId);
const firstPrefix = prefixes[0];
const numberOfPrefixes = prefixes.length;
   */
  getPrefixesForServer(serverId) {
    return this.prefixesForServerId_[serverId] || this.defaultPrefixes_;
  }

  /**
   * Get the primary prefix for the location where msg was sent. This method is synchronous, in order to avoid the overhead
   * of using promises. If called very soon after the bot starts, it might not return the correct prefixes. It
   * might return the default prefixes even though the server has custom prefixes.
   * @param {external:"Eris.Message"} msg
   * @returns {string}
   */
  getPrimaryPrefixForMessage(msg) {
    return this.getPrefixesForMessage(msg)[0];
  }

  /**
   * Get the prefixes for the location where msg was sent. This method is synchronous, in order to avoid the overhead
   * of using promises. If called very soon after the bot starts, it might not return the correct prefixes. It
   * might return the default prefixes even though the server has custom prefixes.
   * @param {external:"Eris.Message"} msg
   * @returns {string[]}
   */
  getPrefixesForMessage(msg) {
    return this.getPrefixesForServer(msg.channel.guild ? msg.channel.guild.id : msg.channel.id);
  }

  /**
   * Edit the data associated with a key. This function is atomic in the sense
   * that no one else can be editing the value for the same key at the same time.
   * @param {string} key
   * @param {Persistence~editFunction} editFunction - The function that performs the edit.
   * @async
   * @example
await persistence.editData('some_key', (data) => {
  data.randomNumber = Math.random() * 100;

  if (!data.numberOfTimesEdited) {
    data.numberOfTimesEdited = 0;
  }

  data.numberOfTimesEdited += 1;

  return data;
});
   */
  editData(key, editFunction) {
    return this.storage.editValue(key, editFunction, {});
  }

  /**
   * Edit the data associated with a user. This function is atomic in the sense
   * that no one else can be editing the value for the same key at the same time.
   * @param {string} userId
   * @param {Persistence~editFunction} editFunction - The function that performs the edit.
   * @async
   * @example
const userId = '123456789';
await editDataForUser(userId, (data) => {
  data.userIsWorthMyTime = false;
  return data;
});
   */
  editDataForUser(userId, editFunction) {
    let key = keyForUserId(userId);
    return this.editData(key, editFunction);
  }

  /**
   * Edit the data associated with a server. This function is atomic in the sense
   * that no one else can be editing the value for the same key at the same time.
   * @param {string} serverId
   * @param {Persistence~editFunction} editFunction - The function that performs the edit.
   * @async
   * @example
const serverId = '123456789';
await editDataForServer(serverId, (data) => {
  data.favoriteUserInServer = 'nobody';
  return data;
});
   */
  editDataForServer(serverId, editFunction) {
    let key = keyForServerId(serverId);
    return this.editData(key, editFunction);
  }

  /**
   * Edit the data global data. This function is atomic in the sense
   * that no one else can be editing the value for the same key at the same time.
   * @param {Persistence~editFunction} editFunction - The function that performs the edit.
   * @async
   * @example await editGlobalData((data) => {
  if (!data.scoreboard) {
    data.scoreboard = {};
  }

  data.scoreboard['John Wick'] = 100;
  return data;
});
   */
  editGlobalData(editFunction) {
    return this.editData(GLOBAL_DATA_KEY, editFunction);
  }

  /**
   * Edit the prefixes associated with a server.
   * @param {string} serverId
   * @param {string[]} prefixes - The new prefixes for the server.
   * @async
   * @example
const serverId = '123456789';
const newPrefixes = ['!', '@', '&amp;!'];
await editPrefixesForServer(serverId, newPrefixes);
   */
  editPrefixesForServerId(serverId, prefixes) {
    if (!prefixes) {
      delete this.prefixesForServerId_[serverId];
    } else {
      const lowercasePrefixes = prefixes.map(prefix => prefix.toLowerCase());
      const uniqueLowercasePrefixes = lowercasePrefixes.filter((prefix, i) => lowercasePrefixes.indexOf(prefix) === i);
      this.prefixesForServerId_[serverId] = uniqueLowercasePrefixes;
    }

    return this.editData(GLOBAL_DATA_KEY, data => {
      data.prefixes = data.prefixes || {};
      data.prefixes[serverId] = this.prefixesForServerId_[serverId];
      return data;
    });
  }

  /**
   * Reset the prefixes associated with a server.
   * @param {string} serverId
   * @async
   */
  resetPrefixesForServerId(serverId) {
    return this.editPrefixesForServerId(serverId, undefined);
  }

  /**
   * Tell persistence that it should stop allowing write operations.
   * @async
   */
  stop() {
    return this.storage.close();
  }
}

module.exports = Persistence;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Sat Sep 21 2019 13:07:41 GMT-0400 (GMT-04:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
